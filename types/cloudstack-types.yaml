
node_types:

  nodecellar.nodes.MonitoredServer:
    derived_from: cloudify.cloudstack.nodes.VirtualMachine

    properties:
      management_network_name:

        #####################################################
        # This is needed for identification of which nic
        # to look for when obtaining the VM ip address
        #####################################################

        default: { get_input: management_network_resource_id }
      cloudify_agent:
          default:
            user: { get_input: agent_user }
      server:
        default:
          image_id: { get_input: image }
          size: { get_input: size }
      network:
        default:
          default_network: { get_input: nodecellar_network_resource_id }

    interfaces:

      ###########################################################
      # We are infact telling cloudify to install a diamond
      # monitoring agent on the server.
      #
      # (see https://github.com/BrightcoveOS/Diamond)
      ###########################################################

      cloudify.interfaces.monitoring_agent:
        install:
          implementation: diamond.diamond_agent.tasks.install
          inputs:
            diamond_config:
              default:
                interval: 1
        start: diamond.diamond_agent.tasks.start
        stop: diamond.diamond_agent.tasks.stop
        uninstall: diamond.diamond_agent.tasks.uninstall

      ###########################################################
      # Adding some collectors. These collectors are necessary
      # for the Cloudify UI to display the deafult metrics.
      ###########################################################

      cloudify.interfaces.monitoring:
        start:
          implementation: diamond.diamond_agent.tasks.add_collectors
          inputs:
            collectors_config:
              default:
                CPUCollector: {}
                MemoryCollector: {}
                LoadAverageCollector: {}
                DiskUsageCollector:
                  config:
                    devices: x?vd[a-z]+[0-9]*$
                NetworkCollector: {}
